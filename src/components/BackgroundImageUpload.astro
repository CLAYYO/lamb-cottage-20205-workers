---
export interface Props {
  sectionId: string;
  fieldPath: string;
  content: string;
  className?: string;
}

const { sectionId, fieldPath, content, className = '' } = Astro.props;
const uploadId = `${sectionId}-${fieldPath.replace(/\./g, '-')}`;
---

<div class={`background-image-upload ${className}`}>
  <!-- Current Image Preview -->
  <div class="current-image-preview">
    {content ? (
      <img 
        src={content} 
        alt="Current background image" 
        class="preview-image"
        style="max-width: 300px; max-height: 200px; object-fit: cover; border-radius: 8px;"
      />
    ) : (
      <div class="no-image-placeholder">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21,15 16,10 5,21"></polyline>
        </svg>
        <p>No image selected</p>
      </div>
    )}
  </div>

  <!-- Upload Controls -->
  <div class="upload-controls">
    <input 
      type="file" 
      id={uploadId}
      accept="image/*"
      class="file-input"
      style="display: none;"
    />
    <button 
      type="button" 
      class="upload-btn"
      onclick={`document.getElementById('${uploadId}').click()`}
    >
      {content ? 'Change Image' : 'Upload Image'}
    </button>
    {content && (
      <button 
        type="button" 
        class="remove-btn"
        onclick={`removeBackgroundImage('${sectionId}', '${fieldPath}')`}
      >
        Remove
      </button>
    )}
  </div>

  <!-- Hidden input to store the current value -->
  <input 
    type="hidden" 
    name={`${sectionId}.${fieldPath}`}
    value={content}
    id={`hidden-${uploadId}`}
  />
</div>

<style>
  .background-image-upload {
    border: 2px dashed #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    background: #f9fafb;
  }

  .current-image-preview {
    margin-bottom: 1rem;
  }

  .no-image-placeholder {
    color: #6b7280;
    padding: 2rem;
  }

  .no-image-placeholder svg {
    margin: 0 auto 0.5rem;
    color: #d1d5db;
  }

  .upload-controls {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .upload-btn {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: background-color 0.2s;
  }

  .upload-btn:hover {
    background: #2563eb;
  }

  .remove-btn {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: background-color 0.2s;
  }

  .remove-btn:hover {
    background: #dc2626;
  }

  .preview-image {
    border: 1px solid #e5e7eb;
  }
</style>

<script>
  // Handle file upload
  document.addEventListener('change', function(e) {
    if (e.target && e.target.type === 'file') {
      const fileInput = e.target;
      const file = fileInput.files[0];
      
      if (file) {
        const formData = new FormData();
        formData.append('image', file);
        
        // Show loading state
        const uploadBtn = fileInput.parentElement.querySelector('.upload-btn');
        const originalText = uploadBtn.textContent;
        uploadBtn.textContent = 'Uploading...';
        uploadBtn.disabled = true;
        
        // Upload the image
        fetch('/api/upload-image', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update the preview and hidden input
            const container = fileInput.closest('.background-image-upload');
            const preview = container.querySelector('.current-image-preview');
            const hiddenInput = container.querySelector('input[type="hidden"]');
            
            // Update preview
            preview.innerHTML = `
              <img 
                src="${data.url}" 
                alt="Current background image" 
                class="preview-image"
                style="max-width: 300px; max-height: 200px; object-fit: cover; border-radius: 8px;"
              />
            `;
            
            // Update hidden input
            hiddenInput.value = data.url;
            
            // Update button text
            uploadBtn.textContent = 'Change Image';
            
            // Add remove button if not exists
            if (!container.querySelector('.remove-btn')) {
              const removeBtn = document.createElement('button');
              removeBtn.type = 'button';
              removeBtn.className = 'remove-btn';
              removeBtn.textContent = 'Remove';
              removeBtn.onclick = function() {
                const sectionId = hiddenInput.name.split('.')[0];
                const fieldPath = hiddenInput.name.split('.').slice(1).join('.');
                removeBackgroundImage(sectionId, fieldPath);
              };
              container.querySelector('.upload-controls').appendChild(removeBtn);
            }
            
            console.log('Image uploaded successfully:', data.url);
          } else {
            alert('Upload failed: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Upload error:', error);
          alert('Upload failed: ' + error.message);
        })
        .finally(() => {
          uploadBtn.textContent = originalText;
          uploadBtn.disabled = false;
        });
      }
    }
  });
  
  // Remove image function
  window.removeBackgroundImage = function(sectionId, fieldPath) {
    const hiddenInput = document.querySelector(`input[name="${sectionId}.${fieldPath}"]`);
    const container = hiddenInput.closest('.background-image-upload');
    const preview = container.querySelector('.current-image-preview');
    const uploadBtn = container.querySelector('.upload-btn');
    const removeBtn = container.querySelector('.remove-btn');
    
    // Clear the value
    hiddenInput.value = '';
    
    // Update preview to placeholder
    preview.innerHTML = `
      <div class="no-image-placeholder">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21,15 16,10 5,21"></polyline>
        </svg>
        <p>No image selected</p>
      </div>
    `;
    
    // Update button text
    uploadBtn.textContent = 'Upload Image';
    
    // Remove the remove button
    if (removeBtn) {
      removeBtn.remove();
    }
  };
</script>